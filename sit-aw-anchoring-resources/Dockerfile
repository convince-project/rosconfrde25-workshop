# version: 0.2.0
FROM ros:humble-ros-base

ENV ROS_DISTRO=humble

ARG DEBIAN_FRONTEND=noninteractive

SHELL ["/bin/bash", "-c"]

RUN chmod 1777 /tmp

ENV USERNAME=user

RUN addgroup "$USERNAME" \
 && adduser "$USERNAME" --gid 1000

RUN apt update &&\
	apt install -y --no-install-recommends wget gedit python3-pip \
	  nlohmann-json3-dev ros-humble-rmw-cyclonedds-cpp

ENV RMW_IMPLEMENTATION=rmw_cyclonedds_cpp

ENV XDG_RUNTIME_DIR=/tmp/runtime-root
RUN mkdir /usr/share/desktop-directories

RUN python3 -m pip install --upgrade pip;	\
    pip3 install pybullet

RUN curl -1sLf \
  'https://repo.typedb.com/public/public-release/setup.deb.sh' \
  | sudo -E bash

RUN apt update &&\
	apt install -y --no-install-recommends typedb=2.28.3

RUN apt update &&\
  wget -q -O /tmp/typedb-studio-linux-2.28.6-1.deb https://repo.typedb.com/public/public-release/raw/names/typedb-studio-linux-x86_64-deb/versions/2.28.6/typedb-studio-linux-x86_64-2.28.6.deb && apt install -y --no-install-recommends /tmp/typedb-studio-linux-2.28.6-1.deb && rm /tmp/typedb-studio-linux-2.28.6-1.deb

# Adjust executable name of typedb studio
RUN ln -s /opt/typedb-studio/bin/TypeDB\ Studio /opt/typedb-studio/bin/typedb-studio

RUN mkdir -p /home/"$USERNAME"/sit-aw-anchoring/humble
#COPY ./workspace/src /home/"$USERNAME"/sit-aw-anchoring/humble/src
WORKDIR /home/"$USERNAME"/sit-aw-anchoring/humble

#Install missing dependencies (most of them should be tackeld above to optimise build time)
#RUN source /opt/ros/humble/setup.bash &&\
#	apt update &&\
#	rosdep fix-permissions &&\
#	rosdep update &&\
#	rosdep install --from-paths src --ignore-src -r -y

#Build the components (separate step to cache the rosdep installs)
#RUN source /opt/ros/humble/setup.bash &&\
#	colcon build --symlink-install

#Set the .bashrc
COPY --chown="$USERNAME":"$USERNAME" ./.bashrc /home/"$USERNAME"/.bashrc
COPY --chown="$USERNAME":"$USERNAME" ./.bash_history /home/"$USERNAME"/.bash_history

#Set the entrypoint
COPY ./entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh
ENTRYPOINT ["/entrypoint.sh"]

#Prepare to work
#WORKDIR /home/"$USERNAME"

